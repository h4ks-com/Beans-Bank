<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Settings - Bean Bank</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .tab {
            padding: 0.8rem 1.5rem;
            background: var(--tab-bg);
            color: var(--text-light);
            border: 1px solid var(--tab-border);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: var(--brand-color);
            color: white;
            border-color: var(--brand-color);
        }

        .tab:hover:not(.active) {
            background: var(--tab-hover);
            border-color: var(--brand-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .harvest-form {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--input-border);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--brand-color);
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .harvest-list {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .harvest-table {
            width: 100%;
            border-collapse: collapse;
        }

        .harvest-table th {
            text-align: left;
            padding: 1rem;
            background: rgba(148, 163, 184, 0.1);
            color: var(--text-secondary);
            font-weight: 600;
            border-bottom: 2px solid var(--table-border);
        }

        .harvest-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--table-border);
            color: var(--text-primary);
        }

        .harvest-table tr:hover {
            background: rgba(148, 163, 184, 0.05);
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-badge.completed {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.open {
            background: #fef3c7;
            color: #92400e;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            padding: 0.5rem;
            background: none;
            border: 1px solid var(--input-border);
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .btn-icon:hover {
            background: var(--brand-color);
            color: white;
            border-color: var(--brand-color);
        }

        .btn-icon.danger:hover {
            background: #ef4444;
            border-color: #ef4444;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
        }

        @media (max-width: 768px) {
            .harvest-table {
                font-size: 0.9rem;
            }

            .harvest-table th,
            .harvest-table td {
                padding: 0.5rem;
            }

            .form-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <i class="fas fa-coins"></i>
            Bean Bank
        </div>
        <div class="user-section">
            <button class="btn btn-secondary btn-small" onclick="toggleTheme()" id="themeToggle" title="Toggle theme">
                <i class="fas fa-moon"></i>
            </button>
            <a href="/" class="btn btn-secondary">
                <i class="fas fa-home"></i>
                Home
            </a>
            {{ if not .TestMode }}
                {{ if .IsAuthenticated }}
                    <a href="/wallet" class="user-info" style="text-decoration: none; cursor: pointer;">
                        <i class="fas fa-user-circle"></i>
                        <span>{{ .Username }}</span>
                    </a>
                    <a href="/auth/logout" class="btn btn-secondary">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </a>
                {{ end }}
            {{ end }}
        </div>
    </div>

    <div class="container">
        <h1 style="margin-bottom: 2rem; color: var(--text-primary);">
            <i class="fas fa-cog"></i> Admin Settings
        </h1>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('harvests')">
                <i class="fas fa-seedling"></i> Harvests
            </div>
        </div>

        <div id="harvestsTab" class="tab-content active">
            <div class="harvest-form" id="harvestFormSection">
                <h2 style="margin-bottom: 1.5rem; color: var(--text-primary);">
                    <span id="formTitle"><i class="fas fa-plus"></i> Create New Harvest</span>
                </h2>

                <form id="harvestForm" onsubmit="saveHarvest(event)">
                    <input type="hidden" id="harvestId" name="id">

                    <div class="form-group">
                        <label for="title">Title *</label>
                        <input type="text" id="title" name="title" required>
                    </div>

                    <div class="form-group">
                        <label for="description">Description (Markdown supported)</label>
                        <textarea id="description" name="description" placeholder="Use markdown for formatting..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="beanAmount">Bean Reward *</label>
                        <input type="number" id="beanAmount" name="bean_amount" min="1" required>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="cancelEdit()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Save Harvest
                        </button>
                    </div>
                </form>
            </div>

            <div class="harvest-list">
                <h2 style="margin-bottom: 1.5rem; color: var(--text-primary);">
                    <i class="fas fa-list"></i> All Harvests
                </h2>

                <div id="harvestTableContainer">
                    <p class="loading"><i class="fas fa-spinner fa-spin"></i> Loading harvests...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="assignModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Assign User to Harvest</h2>
            <form id="assignForm" onsubmit="assignUser(event)">
                <input type="hidden" id="assignHarvestId">

                <div class="form-group">
                    <label for="assignUser">Select User</label>
                    <select id="assignUser" required>
                        <option value="">Loading users...</option>
                    </select>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeAssignModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let harvests = [];
        let users = [];
        let editingId = null;

        async function loadUsers() {
            try {
                const response = await fetch('/api/v1/admin/users', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                users = data.users || [];

                const select = document.getElementById('assignUser');
                select.innerHTML = '<option value="">Select a user...</option>' +
                    users.map(u => `<option value="${u.id}">${u.username}</option>`).join('');
            } catch (error) {
                console.error('Failed to load users:', error);
            }
        }

        async function loadHarvests() {
            try {
                const response = await fetch('/api/v1/admin/harvests', {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                harvests = data.harvests || [];
                renderHarvestTable();
            } catch (error) {
                console.error('Failed to load harvests:', error);
                document.getElementById('harvestTableContainer').innerHTML =
                    '<p class="loading">Failed to load harvests</p>';
            }
        }

        function renderHarvestTable() {
            const container = document.getElementById('harvestTableContainer');

            if (harvests.length === 0) {
                container.innerHTML = '<p class="loading">No harvests found. Create one above!</p>';
                return;
            }

            let html = '<table class="harvest-table"><thead><tr>';
            html += '<th>Title</th><th>Beans</th><th>Assigned</th><th>Status</th><th>Actions</th>';
            html += '</tr></thead><tbody>';

            harvests.forEach(harvest => {
                const statusClass = harvest.completed ? 'completed' : 'open';
                const statusText = harvest.completed ? 'Completed' : 'Open';
                const assignedText = harvest.assigned_user || '-';

                html += `<tr>
                    <td><strong>${harvest.title}</strong></td>
                    <td>${harvest.bean_amount}</td>
                    <td>${assignedText}</td>
                    <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon" onclick="editHarvest(${harvest.id})" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${!harvest.completed ? `
                                <button class="btn-icon" onclick="openAssignModal(${harvest.id})" title="Assign User">
                                    <i class="fas fa-user-plus"></i>
                                </button>
                                ${harvest.assigned_user_id ? `
                                    <button class="btn-icon" onclick="completeHarvest(${harvest.id})" title="Complete">
                                        <i class="fas fa-check"></i>
                                    </button>
                                ` : ''}
                            ` : ''}
                            <button class="btn-icon danger" onclick="deleteHarvest(${harvest.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function saveHarvest(event) {
            event.preventDefault();

            const form = event.target;
            const data = {
                title: form.title.value,
                description: form.description.value,
                bean_amount: parseInt(form.bean_amount.value)
            };

            try {
                const isEdit = editingId !== null;
                const url = isEdit ? `/api/v1/admin/harvests/${editingId}` : '/api/v1/admin/harvests';
                const method = isEdit ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showNotification(isEdit ? 'Harvest updated!' : 'Harvest created!', 'success');
                    cancelEdit();
                    await loadHarvests();
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to save harvest', 'error');
                }
            } catch (error) {
                console.error('Failed to save harvest:', error);
                showNotification('Failed to save harvest', 'error');
            }
        }

        function editHarvest(id) {
            const harvest = harvests.find(h => h.id === id);
            if (!harvest) return;

            editingId = id;
            document.getElementById('harvestId').value = id;
            document.getElementById('title').value = harvest.title;
            document.getElementById('description').value = harvest.description;
            document.getElementById('beanAmount').value = harvest.bean_amount;
            document.getElementById('formTitle').innerHTML = '<i class="fas fa-edit"></i> Edit Harvest';
            document.getElementById('harvestFormSection').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            editingId = null;
            document.getElementById('harvestForm').reset();
            document.getElementById('formTitle').innerHTML = '<i class="fas fa-plus"></i> Create New Harvest';
        }

        async function deleteHarvest(id) {
            if (!confirm('Are you sure you want to delete this harvest?')) return;

            try {
                const response = await fetch(`/api/v1/admin/harvests/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    showNotification('Harvest deleted!', 'success');
                    await loadHarvests();
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to delete harvest', 'error');
                }
            } catch (error) {
                console.error('Failed to delete harvest:', error);
                showNotification('Failed to delete harvest', 'error');
            }
        }

        function openAssignModal(id) {
            document.getElementById('assignHarvestId').value = id;
            document.getElementById('assignModal').classList.add('active');
        }

        function closeAssignModal() {
            document.getElementById('assignModal').classList.remove('active');
            document.getElementById('assignForm').reset();
        }

        async function assignUser(event) {
            event.preventDefault();

            const harvestId = document.getElementById('assignHarvestId').value;
            const userId = document.getElementById('assignUser').value;

            try {
                const response = await fetch(`/api/v1/admin/harvests/${harvestId}/assign`, {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ user_id: parseInt(userId) })
                });

                if (response.ok) {
                    showNotification('User assigned!', 'success');
                    closeAssignModal();
                    await loadHarvests();
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to assign user', 'error');
                }
            } catch (error) {
                console.error('Failed to assign user:', error);
                showNotification('Failed to assign user', 'error');
            }
        }

        async function completeHarvest(id) {
            if (!confirm('Mark this harvest as completed and award beans to the assigned user?')) return;

            try {
                const response = await fetch(`/api/v1/admin/harvests/${id}/complete`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    showNotification('Harvest completed! Beans awarded.', 'success');
                    await loadHarvests();
                } else {
                    const error = await response.json();
                    showNotification(error.error || 'Failed to complete harvest', 'error');
                }
            } catch (error) {
                console.error('Failed to complete harvest:', error);
                showNotification('Failed to complete harvest', 'error');
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            event.target.closest('.tab').classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        function getAuthHeaders() {
            const token = localStorage.getItem('authToken');
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                background: ${type === 'success' ? '#10b981' : '#ef4444'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.2);
                z-index: 10000;
                animation: slideIn 0.3s ease;
            `;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        document.getElementById('assignModal').addEventListener('click', (e) => {
            if (e.target.id === 'assignModal') closeAssignModal();
        });

        loadUsers();
        loadHarvests();
    </script>
    <script src="/static/js/theme.js"></script>
</body>
</html>
